/*
 * Whisper Security API
 *
 * # Whisper Security Threat Intelligence API  The Whisper Security API provides comprehensive threat intelligence, geolocation data, and security operations capabilities for enterprise security teams and developers.  ## Key Capabilities  - **Indicator Enrichment**: Get comprehensive intelligence on IP addresses and domains including   geolocation, WHOIS, DNS, reputation scoring, and relationship mapping. - **Geolocation Services**: Fast IP-to-location lookups with ISP, ASN, and network information. - **Security Operations**: Asynchronous tools for bulk enrichment, infrastructure scanning,   AI-powered threat investigation, and monitoring.  ## API Design  - **RESTful**: Standard HTTP methods (GET, POST, PUT, DELETE) with JSON request/response bodies. - **Synchronous Endpoints**: Fast responses (<500ms) for indicator enrichment and geolocation. - **Asynchronous Jobs**: Long-running operations return a job ID for polling results. - **Consistent Error Handling**: Standardized error responses with status codes, error codes, and messages.  ## Authentication  All API endpoints require Bearer token authentication. Include your API key in the `Authorization` header: `Authorization: Bearer <your-api-key>`  ## Rate Limits  Rate limits are applied per-user and vary by endpoint category:  | Endpoint Category | Rate Limit | Description | |- -- -- -- -- -- -- -- -- --|- -- -- -- -- -- -|- -- -- -- -- -- --| | Indicators (`/v1/indicators/_*`) | 100 req/sec | Single indicator enrichment | | Location (`/v1/location/_*`) | 100 req/sec | Geolocation lookups | | Jobs (`/v1/ops/jobs/_*`) | 100 req/sec | Job status and listing | | Bulk Operations (`/v1/ops/enrichment/bulk`) | 10 req/sec | Bulk indicator processing | | Screenshots (`/v1/ops/screenshots/_*`) | 10 req/sec | Screenshot capture and scheduling | | Scans (`/v1/ops/scans/_*`) | 10 req/sec | Infrastructure scanning | | Monitoring (`/v1/ops/monitoring/_*`) | 10 req/sec | Uptime monitoring | | Tracking (`/v1/ops/tracking/_*`) | 10 req/sec | Change tracking | | AI Investigate (`/v1/ops/ai/investigate`) | 5 req/min | Deep threat investigation | | AI Correlate (`/v1/ops/ai/correlate`) | 5 req/min | Global correlation | | AI Attribute (`/v1/ops/ai/attribute`) | 5 req/min | Threat actor attribution | | AI Pivot (`/v1/ops/ai/pivot`) | 5 req/min | Infrastructure pivoting |  When rate limits are exceeded, the API returns HTTP `429 Too Many Requests` with a `Retry-After` header indicating when you can retry. The response body includes: ```json {   \"error\": \"Too Many Requests\",   \"message\": \"Rate limit exceeded for <category>. Please retry after N seconds.\",   \"retryAfter\": N } ```  ## Response Conventions  - All timestamps are in ISO 8601 format (UTC). - Pagination uses `limit` and `offset` parameters. - Field names use camelCase throughout the API.  ## Official SDKs  - **Python**: [github.com/whisper-sec/sdk-python](https://github.com/whisper-sec/sdk-python) - **TypeScript/JavaScript**: [github.com/whisper-sec/sdk-typescript](https://github.com/whisper-sec/sdk-typescript) - **Java**: [github.com/whisper-sec/sdk-java](https://github.com/whisper-sec/sdk-java) - **C#/.NET**: [github.com/whisper-sec/sdk-csharp](https://github.com/whisper-sec/sdk-csharp)  ## Resources  - **Website**: [whisper.security](https://whisper.security) - **Dashboard**: [dash.whisper.security](https://dash.whisper.security) - Manage API keys and view usage - **Documentation**: [docs.whisper.security](https://docs.whisper.security) - Guides and tutorials 
 *
 * The version of the OpenAPI document: 1.0.0
 * Contact: support@whisper.security
 * Generated by: https://github.com/openapitools/openapi-generator.git
 */

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text.Json;
using System.Text.Json.Serialization;
using System.Net.Http;
using Microsoft.Extensions.DependencyInjection;
using Whisper.Api.Sdk.Api;
using Whisper.Api.Sdk.Model;

namespace Whisper.Api.Sdk.Client
{
    /// <summary>
    /// Provides hosting configuration for Whisper.Api.Sdk
    /// </summary>
    public class HostConfiguration
    {
        private readonly IServiceCollection _services;
        private readonly JsonSerializerOptions _jsonOptions = new JsonSerializerOptions();

        internal bool HttpClientsAdded { get; private set; }

        /// <summary>
        /// Instantiates the class 
        /// </summary>
        /// <param name="services"></param>
        public HostConfiguration(IServiceCollection services)
        {
            _services = services;
            _jsonOptions.Converters.Add(new JsonStringEnumConverter());
            _jsonOptions.Converters.Add(new DateTimeJsonConverter());
            _jsonOptions.Converters.Add(new DateTimeNullableJsonConverter());
            _jsonOptions.Converters.Add(new DateOnlyJsonConverter());
            _jsonOptions.Converters.Add(new DateOnlyNullableJsonConverter());
            _jsonOptions.Converters.Add(new AnalysisMetadataJsonConverter());
            _jsonOptions.Converters.Add(new AttributeRequestJsonConverter());
            _jsonOptions.Converters.Add(new AttributeResultJsonConverter());
            _jsonOptions.Converters.Add(new AttributionContextJsonConverter());
            _jsonOptions.Converters.Add(new BenchmarkInfoJsonConverter());
            _jsonOptions.Converters.Add(new BenchmarkMetricsJsonConverter());
            _jsonOptions.Converters.Add(new BenchmarkResponseJsonConverter());
            _jsonOptions.Converters.Add(new BlacklistScoresJsonConverter());
            _jsonOptions.Converters.Add(new BulkEnrichmentResultJsonConverter());
            _jsonOptions.Converters.Add(new BulkIpLocationRequestJsonConverter());
            _jsonOptions.Converters.Add(new BulkOptionsJsonConverter());
            _jsonOptions.Converters.Add(new BulkRequestJsonConverter());
            _jsonOptions.Converters.Add(new ChangeEventJsonConverter());
            _jsonOptions.Converters.Add(new ChangeTrackingRequestJsonConverter());
            _jsonOptions.Converters.Add(new ChangeTrackingResponseJsonConverter());
            _jsonOptions.Converters.Add(new CityInfoJsonConverter());
            _jsonOptions.Converters.Add(new CoordinatesInfoJsonConverter());
            _jsonOptions.Converters.Add(new CorrelateOptionsJsonConverter());
            _jsonOptions.Converters.Add(new CorrelateRequestJsonConverter());
            _jsonOptions.Converters.Add(new CorrelateResultJsonConverter());
            _jsonOptions.Converters.Add(new CountryInfoJsonConverter());
            _jsonOptions.Converters.Add(new CurrentAssessmentJsonConverter());
            _jsonOptions.Converters.Add(new CypherQueryRequestJsonConverter());
            _jsonOptions.Converters.Add(new CypherQueryResponseJsonConverter());
            _jsonOptions.Converters.Add(new CypherSchemaResponseJsonConverter());
            _jsonOptions.Converters.Add(new DnsInfoJsonConverter());
            _jsonOptions.Converters.Add(new DomainItemJsonConverter());
            _jsonOptions.Converters.Add(new DomainReputationDetailsJsonConverter());
            _jsonOptions.Converters.Add(new DomainReputationScoresJsonConverter());
            _jsonOptions.Converters.Add(new EarlyWarningJsonConverter());
            _jsonOptions.Converters.Add(new ErrorInfoJsonConverter());
            _jsonOptions.Converters.Add(new ErrorResponseJsonConverter());
            _jsonOptions.Converters.Add(new GenericSuccessResponseJsonConverter());
            _jsonOptions.Converters.Add(new GraphLinkJsonConverter());
            _jsonOptions.Converters.Add(new GraphNodeJsonConverter());
            _jsonOptions.Converters.Add(new GraphQLRequestJsonConverter());
            _jsonOptions.Converters.Add(new GraphResponseJsonConverter());
            _jsonOptions.Converters.Add(new HistoryDataJsonConverter());
            _jsonOptions.Converters.Add(new HistoryResponseJsonConverter());
            _jsonOptions.Converters.Add(new IndicatorResponseJsonConverter());
            _jsonOptions.Converters.Add(new IndustryInfoJsonConverter());
            _jsonOptions.Converters.Add(new InfrastructureMapRequestJsonConverter());
            _jsonOptions.Converters.Add(new InvestigateContextJsonConverter());
            _jsonOptions.Converters.Add(new InvestigateRequestJsonConverter());
            _jsonOptions.Converters.Add(new InvestigateResultJsonConverter());
            _jsonOptions.Converters.Add(new IpGeolocationResponseJsonConverter());
            _jsonOptions.Converters.Add(new IspInfoJsonConverter());
            _jsonOptions.Converters.Add(new JobJsonConverter());
            _jsonOptions.Converters.Add(new JobErrorJsonConverter());
            _jsonOptions.Converters.Add(new JobListResponseJsonConverter());
            _jsonOptions.Converters.Add(new JobProgressJsonConverter());
            _jsonOptions.Converters.Add(new JobResponseJsonConverter());
            _jsonOptions.Converters.Add(new JobSummaryJsonConverter());
            _jsonOptions.Converters.Add(new LinksInfoJsonConverter());
            _jsonOptions.Converters.Add(new LocationInfoJsonConverter());
            _jsonOptions.Converters.Add(new MetadataInfoJsonConverter());
            _jsonOptions.Converters.Add(new ModelInfoJsonConverter());
            _jsonOptions.Converters.Add(new MonitorAssertionsJsonConverter());
            _jsonOptions.Converters.Add(new MonitorCheckRequestJsonConverter());
            _jsonOptions.Converters.Add(new MonitorCheckResponseJsonConverter());
            _jsonOptions.Converters.Add(new MonitorDashboardResponseJsonConverter());
            _jsonOptions.Converters.Add(new MonitorListResponseJsonConverter());
            _jsonOptions.Converters.Add(new MonitorResultListResponseJsonConverter());
            _jsonOptions.Converters.Add(new MonitorResultResponseJsonConverter());
            _jsonOptions.Converters.Add(new MonitoringAlertRequestJsonConverter());
            _jsonOptions.Converters.Add(new MonitoringMetricsJsonConverter());
            _jsonOptions.Converters.Add(new MonitoringStatusResponseJsonConverter());
            _jsonOptions.Converters.Add(new PatternMatchingJsonConverter());
            _jsonOptions.Converters.Add(new PercentileInfoJsonConverter());
            _jsonOptions.Converters.Add(new PivotRequestJsonConverter());
            _jsonOptions.Converters.Add(new PivotResultJsonConverter());
            _jsonOptions.Converters.Add(new PredictionPointJsonConverter());
            _jsonOptions.Converters.Add(new PredictionsJsonConverter());
            _jsonOptions.Converters.Add(new PredictiveRiskResponseJsonConverter());
            _jsonOptions.Converters.Add(new ProgressInfoJsonConverter());
            _jsonOptions.Converters.Add(new QueryInfoJsonConverter());
            _jsonOptions.Converters.Add(new RateLimitErrorJsonConverter());
            _jsonOptions.Converters.Add(new RelationshipInfoJsonConverter());
            _jsonOptions.Converters.Add(new ReputationInfoJsonConverter());
            _jsonOptions.Converters.Add(new RiskFactorJsonConverter());
            _jsonOptions.Converters.Add(new ScanRequestJsonConverter());
            _jsonOptions.Converters.Add(new ScheduleWithScreenshotsJsonConverter());
            _jsonOptions.Converters.Add(new ScreenshotEntryJsonConverter());
            _jsonOptions.Converters.Add(new ScreenshotHistoryResponseJsonConverter());
            _jsonOptions.Converters.Add(new ScreenshotOptionsJsonConverter());
            _jsonOptions.Converters.Add(new ScreenshotRequestJsonConverter());
            _jsonOptions.Converters.Add(new ScreenshotScheduleJsonConverter());
            _jsonOptions.Converters.Add(new ScreenshotScheduleConfigJsonConverter());
            _jsonOptions.Converters.Add(new ScreenshotScheduleListResponseJsonConverter());
            _jsonOptions.Converters.Add(new SearchRequestJsonConverter());
            _jsonOptions.Converters.Add(new SearchResponseJsonConverter());
            _jsonOptions.Converters.Add(new SimilarCaseJsonConverter());
            _jsonOptions.Converters.Add(new SimilarCasesRequestJsonConverter());
            _jsonOptions.Converters.Add(new SimilarCasesResultJsonConverter());
            _jsonOptions.Converters.Add(new SimilarDomainEntryJsonConverter());
            _jsonOptions.Converters.Add(new SimilarDomainsOpsRequestJsonConverter());
            _jsonOptions.Converters.Add(new SimilarDomainsResponseJsonConverter());
            _jsonOptions.Converters.Add(new SubdomainInfoJsonConverter());
            _jsonOptions.Converters.Add(new SubdomainResponseJsonConverter());
            _jsonOptions.Converters.Add(new SummaryInfoJsonConverter());
            _jsonOptions.Converters.Add(new ThreatProfileJsonConverter());
            _jsonOptions.Converters.Add(new TrackedIndicatorJsonConverter());
            _jsonOptions.Converters.Add(new TrackedIndicatorsResponseJsonConverter());
            _jsonOptions.Converters.Add(new TrackingConfigJsonConverter());
            _jsonOptions.Converters.Add(new TraitsInfoJsonConverter());
            _jsonOptions.Converters.Add(new TrajectoryInfoJsonConverter());
            _jsonOptions.Converters.Add(new TrendDataJsonConverter());
            JsonSerializerOptionsProvider jsonSerializerOptionsProvider = new(_jsonOptions);
            _services.AddSingleton(jsonSerializerOptionsProvider);
            _services.AddSingleton<IApiFactory, ApiFactory>();
            _services.AddSingleton<AIIntelligenceApiEvents>();
            _services.AddSingleton<ChangeTrackingApiEvents>();
            _services.AddSingleton<EnrichmentApiEvents>();
            _services.AddSingleton<GraphDatabaseApiEvents>();
            _services.AddSingleton<InfrastructureScanningApiEvents>();
            _services.AddSingleton<JobsApiEvents>();
            _services.AddSingleton<LocationApiEvents>();
            _services.AddSingleton<MonitoringApiEvents>();
            _services.AddSingleton<ScreenshotsApiEvents>();
        }

        /// <summary>
        /// Configures the HttpClients.
        /// </summary>
        /// <param name="client"></param>
        /// <param name="builder"></param>
        /// <returns></returns>
        public HostConfiguration AddApiHttpClients
        (
            Action<HttpClient> client = null, Action<IHttpClientBuilder> builder = null)
        {
            if (client == null)
                client = c => c.BaseAddress = new Uri(ClientUtils.BASE_ADDRESS);

            List<IHttpClientBuilder> builders = new List<IHttpClientBuilder>();

            builders.Add(_services.AddHttpClient<IAIIntelligenceApi, AIIntelligenceApi>(client));
            builders.Add(_services.AddHttpClient<IChangeTrackingApi, ChangeTrackingApi>(client));
            builders.Add(_services.AddHttpClient<IEnrichmentApi, EnrichmentApi>(client));
            builders.Add(_services.AddHttpClient<IGraphDatabaseApi, GraphDatabaseApi>(client));
            builders.Add(_services.AddHttpClient<IInfrastructureScanningApi, InfrastructureScanningApi>(client));
            builders.Add(_services.AddHttpClient<IJobsApi, JobsApi>(client));
            builders.Add(_services.AddHttpClient<ILocationApi, LocationApi>(client));
            builders.Add(_services.AddHttpClient<IMonitoringApi, MonitoringApi>(client));
            builders.Add(_services.AddHttpClient<IScreenshotsApi, ScreenshotsApi>(client));
            
            if (builder != null)
                foreach (IHttpClientBuilder instance in builders)
                    builder(instance);

            HttpClientsAdded = true;

            return this;
        }

        /// <summary>
        /// Configures the JsonSerializerSettings
        /// </summary>
        /// <param name="options"></param>
        /// <returns></returns>
        public HostConfiguration ConfigureJsonOptions(Action<JsonSerializerOptions> options)
        {
            options(_jsonOptions);

            return this;
        }

        /// <summary>
        /// Adds tokens to your IServiceCollection
        /// </summary>
        /// <typeparam name="TTokenBase"></typeparam>
        /// <param name="token"></param>
        /// <returns></returns>
        public HostConfiguration AddTokens<TTokenBase>(TTokenBase token) where TTokenBase : TokenBase
        {
            return AddTokens(new TTokenBase[]{ token });
        }

        /// <summary>
        /// Adds tokens to your IServiceCollection
        /// </summary>
        /// <typeparam name="TTokenBase"></typeparam>
        /// <param name="tokens"></param>
        /// <returns></returns>
        public HostConfiguration AddTokens<TTokenBase>(IEnumerable<TTokenBase> tokens) where TTokenBase : TokenBase
        {
            TokenContainer<TTokenBase> container = new TokenContainer<TTokenBase>(tokens);
            _services.AddSingleton(services => container);

            return this;
        }

        /// <summary>
        /// Adds a token provider to your IServiceCollection
        /// </summary>
        /// <typeparam name="TTokenProvider"></typeparam>
        /// <typeparam name="TTokenBase"></typeparam>
        /// <returns></returns>
        public HostConfiguration UseProvider<TTokenProvider, TTokenBase>() 
            where TTokenProvider : TokenProvider<TTokenBase>
            where TTokenBase : TokenBase
        {
            _services.AddSingleton<TTokenProvider>();
            _services.AddSingleton<TokenProvider<TTokenBase>>(services => services.GetRequiredService<TTokenProvider>());

            return this;
        }
    }
}
